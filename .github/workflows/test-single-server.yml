name: Run Kaggle (Attempt T4 / Fallback P100)

on:
  push:
  workflow_dispatch:

jobs:
  kaggle-execution:
    runs-on: ubuntu-latest
    
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Kaggle CLI
        run: pip install kaggle

      - name: Patch and Push Kernel
        env:
          KAGGLE_USERNAME: "shreevathsbbhh"
          KAGGLE_KEY: "83a92caa96ed51b5d5a9a730100c57aa"
        run: |
          mkdir kaggle_run
          cd kaggle_run

          # 1. Pull the current code and metadata
          kaggle kernels pull shreevathsbbhh/gpusss -m -p .

          # 2. PYTHON SCRIPT: Force T4 Tags + Enable GPU
          python3 -c '
          import json
          import glob

          # --- Step A: Patch kernel-metadata.json ---
          # We MUST have "enable_gpu": "true" or it goes to CPU.
          # We also add "accelerator" keys, though API often ignores them.
          try:
              with open("kernel-metadata.json", "r") as f:
                  meta = json.load(f)
              
              # CRITICAL: This enables the GPU (likely P100 due to API limits)
              meta["enable_gpu"] = "true"
              
              # Best effort request for T4
              meta["accelerator"] = "nvidiaTeslaT4"
              meta["gpuAcceleratorType"] = "nvidiaTeslaT4"
              
              with open("kernel-metadata.json", "w") as f:
                  json.dump(meta, f, indent=4)
              print("Metadata patched: GPU Enabled.")
          except Exception as e:
              print(f"Metadata patch failed: {e}")

          # --- Step B: Patch notebook (.ipynb) internals ---
          # This ensures the internal notebook file requests T4
          nb_files = glob.glob("*.ipynb")
          if nb_files:
              nb_path = nb_files[0]
              with open(nb_path, "r") as f:
                  nb = json.load(f)

              if "metadata" not in nb: nb["metadata"] = {}
              if "kaggle" not in nb["metadata"]: nb["metadata"]["kaggle"] = {}

              # Force T4 settings internally
              nb["metadata"]["kaggle"]["accelerator"] = "nvidiaTeslaT4"
              nb["metadata"]["kaggle"]["gpuAcceleratorType"] = "nvidiaTeslaT4"
              nb["metadata"]["kaggle"]["isGpuEnabled"] = True
              
              with open(nb_path, "w") as f:
                  json.dump(nb, f, indent=4)
              print("Notebook file patched for T4.")
          '

          # 3. Push to Kaggle
          # This will launch the run. 
          # Note: If Kaggle gives P100, it is a server-side API limitation.
          kaggle kernels push -p .
