name: Run Kaggle Notebook (Force T4 x2)

on:
  push:
  workflow_dispatch:

jobs:
  force-gpu-t4-run:
    runs-on: ubuntu-latest
    
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Kaggle CLI
        run: pip install kaggle

      - name: Force T4 Execution
        env:
          KAGGLE_USERNAME: "shreevathsbbhh"
          KAGGLE_KEY: "83a92caa96ed51b5d5a9a730100c57aa"
        run: |
          mkdir kaggle_run
          cd kaggle_run

          # 1. Pull current code and metadata
          kaggle kernels pull shreevathsbbhh/gpusss -m -p .

          # 2. PATCH THE METADATA FILE (kernel-metadata.json)
          # We manually inject the accelerator field which the CLI usually ignores
          # jq is used here to safely insert the field
          jq '. + {"accelerator": "nvidiaTeslaT4"}' kernel-metadata.json > kernel-metadata.json.tmp && mv kernel-metadata.json.tmp kernel-metadata.json

          # 3. PATCH THE NOTEBOOK FILE (.ipynb)
          # We use Python to inject the specific T4 keys into the notebook JSON
          python3 -c '
          import json
          import glob

          nb_files = glob.glob("*.ipynb")
          if nb_files:
              filename = nb_files[0]
              print(f"Patching {filename}...")
              
              with open(filename, "r") as f:
                  data = json.load(f)

              # Create metadata path if missing
              if "metadata" not in data: data["metadata"] = {}
              if "kaggle" not in data["metadata"]: data["metadata"]["kaggle"] = {}

              # FORCE T4 CONFIGURATION
              # "nvidiaTeslaT4" usually activates T4 x2 on Kaggle (as single T4 is rarely an option)
              data["metadata"]["kaggle"]["accelerator"] = "nvidiaTeslaT4"
              data["metadata"]["kaggle"]["gpuAcceleratorType"] = "nvidiaTeslaT4"
              data["metadata"]["kaggle"]["isGpuEnabled"] = True
              
              with open(filename, "w") as f:
                  json.dump(data, f, indent=4)
              print("Patch applied.")
          '

          # 4. Push the patched files
          kaggle kernels push -p .
